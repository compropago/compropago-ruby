
#ComproPago Ruby SDK

## Description

The gem of `ComproPago Ruby SDK` allows you to interact with the API of ComproPago in your application. 
It also has the necessary methods to facilitate development through the most used services (SDK).

With ComproPago you can receive payments at 7Eleven, Extra and more stores throughout Mexico.

## Requirements

Ruby Gems
Ruby >= 1.9

## Installation ComproPago Ruby Gem

Installation by rubygems.org
You can directly install the gem with the following command:

gem install compropago_sdk

Or you can choose to add it to your dependency list within your Gemfile file as follows:

gem 'compropago_sdk'

## Installation by GitHub

You can get the repository

#repository in its current state (* may not be stable version *)
git clone https://github.com/compropago/compropago-ruby.git
After the download of the gem code, unzip the downloaded file and enter the resulting folder. In a terminal with the following commands:

### Uninstall any previous version of the gem
sudo gem uninstall compropago *

### Generation of the new compilation of the gem
gem build compropago.gemspec

### Installation of the new compiled
sudo gem install compropago * .gem

## Basic Use Guide
You must have an active CompraPago account.

### General
To be able to make use of the library it is necessary to include the main library of the gem

require 'compropago_sdk'

### Client Configuration

To make use of the gem and API calls it is necessary that you first configure your Connection Keys and create a Client instance. 
You will find your keys in your Checkout Panel in the Settings menu.

```ruby
# @param string publickey     Public key corresponding to the store mode
# @param string privatekey    Private key corresponding to the store mode
# @param bool   live          Store mode (false = Test | true = Live)

client = Client.new (
     'pk_test_5989d8209974e2d62', # publickey
     'sk_test_6ff4e982253c44c42', # privatekey
     false # live
)
```

### Basic use of the gem

> Consult the Ruby bookstore of ComproPago to learn more about its capabilities, configurations and methods.

#### Called to services by SDK
To be able to use the ComproPago services, you just have to call the methods contained in the api property of the **client** variable as shown below.

#### Base methods of the SDK

##### Create a new Payment order

```ruby
# @param [string | number] order_id     Internal ID of the order
# @param [string] order_name            Name of the order, products or service
# @param [float] order_price            Order amount
# @param [string] customer_name         Customer name
# @param [string] customer_email        Customer email
# @param [string] payment_type          (default = SEVEN_ELEVEN) Store in which the deposit will be made (internal_name of Provider objects)
# @param [string] currency              (default = MXN) Currency of the currency for the collection (USD, EUR, GBP, MXN)
# @param [int] expiration_time          (default = nil) Date in Epoch format to mark the expiration of the order
order_info = {
    order_id: 123,
    order_name: 'M4 unit ruby',
    order_price: 123.45,
    customer_name: 'Eduardo Aguilar',
    customer_email: 'eduardo.aguilar@compropago.com',
    payment_type: 'SEVEN_ELEVEN',
    currency: 'MXN',
    expiration_time: 1484786210
}

order = Factory :: get_instance_of 'PlaceOrderInfo', order_info


# Call the 'place_order' method of the API to generate the order

# @param [PlaceOrderInfo] order
# @return [NewOrderInfo]

new_order = client.api.place_order order
```

###### Prototype of the place_order() method
```ruby
# @param [PlaceOrderInfo] info
# @return [NewOrderInfo]
def place_order (info)
end
```

##### Verify the Status of an order
To verify the status of a generated order it is necessary to call the **verify_order** method that provides the api attribute of the **Client** object and which returns a **CpOrderInfo** instance. 
This method receives as parameter the ID generated by ComproPago for each order. You can also get this ID from a **NewOrderInfo** object by accessing the **id** attribute.

```ruby

# Save the order ID
order_id = "ch_xxxx_xxx_xxx_xxxx";

# U get it from a targeted NewOrderInfo
order_id = new_order.id

# Call the API method to retrieve the order information
info = client.api.verify_order order_id
```

###### Prototype of verify_order() method

```ruby
# @param [String] id
# @return [CpOrderInfo]
def verify_order (id)
end
```

##### Get the list of stores where you can make the payment
To obtain the list of available Suppliers to make the payment of the orders it is necessary to consult the **list_providers** method that is hosted in the **api** attribute of the **Client** object and which returns an instance of type **Array** which will contain objects of type **Provider**

```ruby
providers = client.api.list_providers
```

###### Prototype of the get_providers() method

```ruby
# @param [float] limit
# @param [string] currency
# @return [array]
def list_providers (limit = 0, currency = 'MXN')
end
```

##### Sending SMS instructions
To send the purchase instructions via SMS it is necessary to call the **send_sms_instructions** method that is hosted in the **api** attribute of the **Client** object and which returns an instance of type **SmsInfo**

```ruby
# Number to which the instructions will be sent
phone_number = "55xxxxxxxx";

# Id of the purchase order from which the instructions will be sent
order_id = "ch_xxxxx-xxxxx-xxxxx-xxxxx";

# Call the API method to send the instructions
smsinfo = client.api.send_sms_instructions phone_number, order_id
```

###### Prototype of the send_sms_instructions() method

```ruby
# @param [String] number
# @param [String] id
# @return [SmsInfo]
def send_sms_instructions (number, id)
end
```

#### Webhooks
The webhooks are of great importance for the process of the orders of ComproPago, since they will be in charge of receiving notifications of the change in the status of the purchase orders generated, 
they must also contain part of the logic of approval in their online store. The process is the following:

1. When an order changes its status, our platform will notify each of the registered routes with the order information modified in JSON format.

2. You must recover this JSON in a text string to later convert it to an object of type **CpOrderInfo** using the Factory class provided by the SDK in the following way:

```ruby
info = Factory.get_instance_of 'CpOrderInfo', string_obtained
```

3. Generate the approval logic corresponding to the status of the order.


##### Create a new Webhook
To create a new Webhook in the account, you must call the **create_webhook** method that is hosted in the **api** attribute of the **Client** object and which returns an instance of type **Webhook**

```ruby
# The URL is passed to the webhook as parameter
webhook = client.api.create_webhook 'http://sitio.com/webhook'
```

###### Prototype of the create_webhook() method
```ruby
# @param [String] url
# @return [Webhook]
def create_webhook (url)
end
```

##### Update a Webhook

To update the url of a webhook, you must call the **update_webhook** method that is hosted in the **api** attribute of the **Client** object and which returns an instance of type **Webhook**

```ruby
updated_webhook = client.api.update_webhook webhook.id, 'http://sitio.com/nuevo_webhook'
```

###### Prototype of the update_webhook() method

```ruby
# @param [String] url
# @param [String] id
# @return [Webhook]
def update_webhook (id, url)
end
```

##### Remove a Webhook
To delete a webhook, you must call the **delete_webhook** method that is hosted in the **api** attribute of the **Client** object and which returns an instance of type **Webhook**

```ruby
deleted_webhook = client.api.delete_webhook webhook.id
```

##### Prototype of the delete_webhook() method

```ruby
# @param [String] id
# @return [Webhook]
def delete_webhook (id)
end
```

##### Get a list of registered Webhooks

To obtain the list of webhooks registered in an account, you must call the **list_webhook** method which is hosted in the **api** attribute of the **Client** object and which returns an instance of type Array which contains **Webhook** type objects

```ruby
webhooks = client.api.list_webhooks
```

##### Prototype of the list_webhook() method
```ruby
# @return [Array]
def list_webhooks
end
```
